using System;
using System.ComponentModel.DataAnnotations;
using System.ComponentModel.DataAnnotations.Schema;

namespace frutas.Models
{
    /// <summary>
    /// Entidad para manejar las API Keys de autenticación
    /// Permite acceso seguro a los endpoints de la API
    /// </summary>
    [Table("ApiKeys")]
    public class ApiKey
    {
        /// <summary>
        /// Identificador único de la API Key
        /// </summary>
        [Key]
        public int Id { get; set; }

        /// <summary>
        /// Valor único de la API Key
        /// </summary>
        [Required]
        [StringLength(255)]
        [Index("IX_ApiKey_KeyValue", IsUnique = true)]
        public string KeyValue { get; set; }

        /// <summary>
        /// ID del usuario propietario de la API Key
        /// </summary>
        [Required]
        public int UsuarioId { get; set; }

        /// <summary>
        /// Nombre descriptivo de la API Key
        /// </summary>
        [Required]
        [StringLength(100)]
        [Display(Name = "Nombre de la API Key")]
        public string Nombre { get; set; }

        /// <summary>
        /// Descripción del propósito de la API Key
        /// </summary>
        [StringLength(500)]
        [Display(Name = "Descripción")]
        public string Descripcion { get; set; }

        /// <summary>
        /// Fecha de creación de la API Key
        /// </summary>
        [Required]
        [Display(Name = "Fecha de Creación")]
        public DateTime FechaCreacion { get; set; } = DateTime.Now;

        /// <summary>
        /// Fecha de expiración de la API Key
        /// </summary>
        [Display(Name = "Fecha de Expiración")]
        [DataType(DataType.Date)]
        public DateTime? FechaExpiracion { get; set; }

        /// <summary>
        /// Indica si la API Key está activa
        /// </summary>
        [Display(Name = "Activa")]
        public bool Activo { get; set; } = true;

        /// <summary>
        /// Fecha del último uso de la API Key
        /// </summary>
        [Display(Name = "Último Uso")]
        public DateTime? UltimoUso { get; set; }

        /// <summary>
        /// Contador de veces que se ha usado la API Key
        /// </summary>
        [Display(Name = "Usos Totales")]
        public int ContadorUsos { get; set; } = 0;

        /// <summary>
        /// Límite de requests por hora (0 = sin límite)
        /// </summary>
        [Display(Name = "Límite por Hora")]
        public int LimitePorHora { get; set; } = 1000;

        /// <summary>
        /// Permisos de la API Key (READ, WRITE, DELETE, ALL)
        /// </summary>
        [StringLength(50)]
        [Display(Name = "Permisos")]
        public string Permisos { get; set; } = "READ";

        /// <summary>
        /// IP addresses permitidas (separadas por coma, vacío = todas)
        /// </summary>
        [StringLength(500)]
        [Display(Name = "IPs Permitidas")]
        public string IPsPermitidas { get; set; }

        /// <summary>
        /// Referencia al usuario propietario
        /// </summary>
        [ForeignKey("UsuarioId")]
        public virtual Usuario Usuario { get; set; }

        /// <summary>
        /// Verifica si la API Key es válida
        /// </summary>
        /// <returns>True si es válida</returns>
        public bool EsValida()
        {
            if (!Activo) return false;
            if (FechaExpiracion.HasValue && FechaExpiracion.Value <= DateTime.Now) return false;
            return true;
        }

        /// <summary>
        /// Verifica si la IP está permitida para esta API Key
        /// </summary>
        /// <param name="ip">IP a verificar</param>
        /// <returns>True si está permitida</returns>
        public bool IPEstaPermitida(string ip)
        {
            if (string.IsNullOrEmpty(IPsPermitidas)) return true;
            return IPsPermitidas.Contains(ip);
        }

        /// <summary>
        /// Verifica si el usuario tiene el permiso especificado
        /// </summary>
        /// <param name="permiso">Permiso a verificar</param>
        /// <returns>True si tiene el permiso</returns>
        public bool TienePermiso(string permiso)
        {
            if (Permisos == "ALL") return true;
            return Permisos.Contains(permiso);
        }

        /// <summary>
        /// Registra el uso de la API Key
        /// </summary>
        public void RegistrarUso()
        {
            UltimoUso = DateTime.Now;
            ContadorUsos++;
        }

        /// <summary>
        /// Genera una nueva API Key aleatoria
        /// </summary>
        /// <returns>String con la nueva API Key</returns>
        public static string GenerarNuevaKey()
        {
            return Guid.NewGuid().ToString("N") + DateTime.Now.Ticks.ToString("X");
        }
    }
}